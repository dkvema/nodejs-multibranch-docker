
https://jmet-rpmbuild.apple.com:8443/artifactory/webapp/#/artifacts/browse/tree/General/artifactory-build-info
for server details,vip Details
https://quip-apple.com/KogbAgvg5At6
https://quip-apple.com/0PI5AxvS4kVJ
https://quip-apple.com/cETQAD2lEyEm -whitelisting
git repo url - https://apnw-git.apple.com
git clone git@apnw-git.apple.com:jmet-sre/jmet-jenkins-pipelines.git
git clone git@apnw-git.apple.com:jmet-app/rpm.git

1.login to git
2.create feature branch with any name in rpm repo from master branch
3.clone the rpm repo
git clone git@apnw-git.apple.com:jmet-app/rpm.git

git clone ttps://cst.apple.com/tkt.do?tkt=CHG000331683 - rdar://68498760

4.switch to feature branch
5.check muhan project
5.go to config file
    1.conf.conf (production)
    2.confstress.conf (stress)
6. add the new site details in conf.conf similar to below.(bifrost ip-we can ask jonathan,)
   e.g ITBG site
    stagging environment
    10.88.178.112:itbg-j1p1-muhan1
    10.88.182.112:itbg-j2p1-muhan1
       BIFROST_VIP (read/write)-  we can ask jonathan BIFROST_VIP ip details with read and write
    we need to update the fields for any  site   PS_VIP,MUHAN_ORA_VIP,MUHAN_ORA_PORT,BIFROST_VIP,RELEASE_TMP(increment by 1 ),HUBBLE_SERVICE_IP
After receiving the BIFROST_VIP  and port details run below command
e.g BIFROST_VIP  - 10.88.191.27 and port 9093
check ACL for BIFROST_IP
command : nc -v 10.88.191.27 9093
when run above command output comes as connected.then it is fine
Check ACL  for HUBBLE_SERVICE_IP . Port number you will refer in RPM project  git master branch then command and test.ACL connection is ok or not
/muhan/conf/config/hubble.properties
command : nc -v 10.88.191.17 8080
when run above command output comes as connection refused.then there is some port number wrong.rerun with correct PORT
verify in /muhan/conf/config/hubble.properties hubble.publisher.tcp.server.url=tcp://cfg_HUBBLE_SERVICE_IP:9898
command : nc -v 10.88.191.17 9898
when run above command output comes as connected.then it is fine


conf.conf ,confstress.conf (same content in both files)
--------------------------------------------------------

[itbg_j1p1]
SITE_TMP=itbg_j1p1
SITE_NAME_IN_CONFIG=ITBG
VERSION_TMP=2.0.0
RELEASE_TMP=23
PROCESS_TMP=tomcat
REQUEST_BUNDLE=false
BUNDLE_SIZE=1000
PS_VIP=17.113.154.17
BIFROST_VIP=10.88.191.27
PRIMARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
SECONDARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
ROW_CNT=100
CLIENT_ID=itbg-muhanproducer-prod-service
HUBBLE_SERVICE_IP=10.88.191.17
BUNDLE_INTERVAL=600000
SYSLOG_IP=10.88.191.57
MUHAN_ORA_PROTO=TCP
MUHAN_ORA_VIP=10.88.191.51
MUHAN_ORA_PORT=1740
MUHAN_ORA_SNAME=MUITBG_RW
QUEUE_SIZE=400
COLO_VIP=http://localhost:8080/snMetadata
EMAIL_NOTI_ENABLED=false

[itbg_j1p1_staging]
SITE_TMP=itbg_j1p1_staging
SITE_NAME_IN_CONFIG=ITBG_STAGING
VERSION_TMP=2.0.0
RELEASE_TMP=23
PROCESS_TMP=tomcat
REQUEST_BUNDLE=false
BUNDLE_SIZE=1000
PS_VIP=17.113.154.18
BIFROST_VIP=10.88.191.27
PRIMARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
SECONDARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
ROW_CNT=100
CLIENT_ID=itbg-muhanproducer-prod-service
HUBBLE_SERVICE_IP=10.88.191.17
BUNDLE_INTERVAL=600000
SYSLOG_IP=10.88.191.57
MUHAN_ORA_PROTO=TCP
MUHAN_ORA_VIP=10.88.191.51
MUHAN_ORA_PORT=1740
MUHAN_ORA_SNAME=MUITBG_RW
QUEUE_SIZE=50
COLO_VIP=http://localhost:8080/snMetadata
EMAIL_NOTI_ENABLED=false

[itbg_j2p1]
SITE_TMP=itbg_j2p1
SITE_NAME_IN_CONFIG=ITBG
VERSION_TMP=2.0.0
RELEASE_TMP=23
PROCESS_TMP=tomcat
REQUEST_BUNDLE=false
BUNDLE_SIZE=1000
PS_VIP=17.113.154.17
BIFROST_VIP=10.88.191.27
PRIMARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
SECONDARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
ROW_CNT=100
CLIENT_ID=itbg-muhanproducer-prod-service
HUBBLE_SERVICE_IP=10.88.191.17
BUNDLE_INTERVAL=600000
SYSLOG_IP=10.88.191.57
MUHAN_ORA_PROTO=TCP
MUHAN_ORA_VIP=10.88.191.51
MUHAN_ORA_PORT=1740
MUHAN_ORA_SNAME=MUITBG_RW
QUEUE_SIZE=400
COLO_VIP=http://localhost:8080/snMetadata
EMAIL_NOTI_ENABLED=false

[itbg_j2p1_staging]
SITE_TMP=itbg_j2p1_staging
SITE_NAME_IN_CONFIG=ITBG_STAGING
VERSION_TMP=2.0.0
RELEASE_TMP=23
PROCESS_TMP=tomcat
REQUEST_BUNDLE=false
BUNDLE_SIZE=1000
PS_VIP=17.113.154.18
BIFROST_VIP=10.88.191.27
PRIMARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
SECONDARY_TOPIC=JMET-INSIGHT-PROD-MUHAN-SN-RECEIPTS
ROW_CNT=100
CLIENT_ID=itbg-muhanproducer-prod-service
HUBBLE_SERVICE_IP=10.88.191.17
BUNDLE_INTERVAL=600000
SYSLOG_IP=10.88.191.57
MUHAN_ORA_PROTO=TCP
MUHAN_ORA_VIP=10.88.191.51
MUHAN_ORA_PORT=1740
MUHAN_ORA_SNAME=MUITBG_RW
QUEUE_SIZE=50
COLO_VIP=http://localhost:8080/snMetadata
EMAIL_NOTI_ENABLED=false

step 7: commit the code to feature branch
step 8: create merge request and get it merge done
step 9:run the rpm pipeline for conf rpm
        https://apnw-jenkinsmaster02.apple.com:8080/jenkins/job/build_rpm/job/jmet-rpm-build-git/build?delay=0sec
        app name : Muhan
        component :conf
step 10:run the rpm pipeline confstress
        https://apnw-jenkinsmaster02.apple.com:8080/jenkins/job/build_rpm/job/jmet-rpm-build-git/build?delay=0sec
        app name : Muhan
        component :confstress
step 11 :again run the rpm pipeline oracle-healthcheck-config rpm
        https://apnw-jenkinsmaster02.apple.com:8080/jenkins/job/build_rpm/job/jmet-rpm-build-git/build?delay=0sec
        app name : Muhan
        component :oracle-healthcheck-config

step 12: Verify Rpm's in the artifactory.
https://jmet-rpmbuild.apple.com:8443/artifactory/webapp/#/artifacts/browse/tree/General/artifactory-build-info/workflows%20%253A%253A%20generate_rpm
jmet-muhan-conf-2.0.0-23.itbg_j1p1.noarch.rpm
jmet-muhan-conf-2.0.0-23.itbg_j1p1_staging.noarch.rpm
jmet-muhan-conf-2.0.0-23.itbg_j2p1.noarch.rpm
jmet-muhan-conf-2.0.0-23.itbg_j2p1_staging.noarch.rpm
jmet-muhan-oracle-healthcheck-conf-1.0.0.11.itbg_j2p1.noarch.rpm
jmet-muhan-oracle-healthcheck-conf-1.0.0.11.itbg_j1p1.noarch.rpm


step 13: Need to change the labels of Hosts in jenkins
https://apnw-jenkinsmaster02.apple.com:8080/jenkins/multi-slave-config-plugin/slavefilter
find muhan -itbg node name in the above pipeline
step 14: bring up the slaves in all the nodes
          goto jenkins directory  and ./runslave.bash
step 15: This is a new site.due to that zero serial numbers available in db.if it is exsisting site then need to run different pipeline.
For the site, which is running muhan 1.7 version, with zero serial numbers
https://apnw-jenkinsmaster02.apple.com:8080/jenkins/job/workflows/job/muhan-oraclevm/job/generic-workflow-oracle-schema-setup-1-9/

step 16: Need to update the oracle-health-check RPM version to 11 in oracle VM healthcheck jenkins pipeline and run the pipeline

https://apnw-jenkinsmaster02.apple.com:8080/jenkins/job/workflows/job/muhan-oraclevm/job/generic-workflow-oracle-healthcheck-app-deployment/

step 17: verify the oracle rpm version in oraclevm servers

step 18:start the oracle server in all oracle VM's using below step
cd /ngs/app/home/muhanp/muhan-healthcheck/tomcat/bin
./startup.sh
step 18: update the rpm version to 23 in muhan-app jenkins pipeline and run the pipeline
step 19: verify the rpm version in  all muhan-app server and update in APP Inventory
          https://quip-apple.com/TwXeA5bOX106

step 20: verify version of the root.war file using below command and check the version in the Muhan Version 1.9/1.9.1 Deployment and Setup quip page and muhan app quip page.
          cd /ngs/app/home/muhanp/muhan/tomcat/webapps
          md5sum ROOT.war
step 21: In all the app-hosts go to below config and change the queue value to 0 and verify muhan_user and password is correct
         /ngs/app/home/muhanp/muhan/tomcat/config/application.config
         app.muhan.localqueue.size=0
step 22: In all the app-hosts go to below config and verify muhan_user and password is correct if wrong change the same.
                  spring.datasource.username=MUHAN_USER
                  spring.datasource.password=mJba8_CzoNJTVMqBj_9kekgo
Whitelisting new Site
---------------------
1.launch sql developer and connect to muhan DC db
2.Check whether site is available or Not
-------
 select * from MUHAN_SITE
 select * from MUHAN_SITE where SITE_NAME = 'ITBG';
3.Assume no site with ITBG
----------
Insert into MUHAN_SITE (ID,SITE_NAME,DESCRIPTION,SITE_URL,CREATED_DATE,UPDATED_DATE) values (1016,'ITBG','ITBG','http://17.113.154.17:8080',to_timestamp(SYSDATE, 'DD/MM/RR HH12:mi:SSXFF AM'),to_timestamp(SYSDATE, 'DD/MM/RR HH12:mi:SSXFF AM'));
commit ;
4.if wrongly updated  the VIP Details in the above query then update with below query and commit the code.
-----
update MUHAN_SITE set SITE_URL='http://17.113.154.17:8080' where SITE_NAME='ITBG';
commit ;
5.whitelist the Product P38 through SQL devloper into Muhan DC
----------------------------
INSERT INTO muhan_site_product_link (
site_id,
product_id
) VALUES (
(
SELECT
id
FROM
muhan_site
WHERE
site_name = 'FXGL'
),
(
SELECT
id
FROM
muhan_product_lines
WHERE
product_line = 'P38'
AND status = 'ACTIVE'
)
);
commit;
6.whitelist P38 product in stress schema via oracle VM
step1:login to oraclevm1 and connect to sql using stress owner user
step2:
function get_site_name () { SITE=$(hostname | cut -d. -f1 ); case "$SITE" in *eqwwhk* ) SITE=$(echo $SITE | cut -d- -f3) ;; *atteek* ) SITE=$(echo $SITE | cut -d- -f3) ;; * ) SITE=$(echo $SITE | cut -d- -f1) ;; esac; echo $SITE; }
SITENAME=$(get_site_name)
export ORACLE_HOME=`cat /etc/oratab | grep ^mu${SITENAME} | cut -d: -f2`
DB_SERVICE=MU`echo ${SITENAME} | tr '[:lower:]' '[:upper:]'`_RW
DB_URL="'(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST="localhost")(PORT=1740))(CONNECT_DATA=(SERVICE_NAME="$DB_SERVICE")))'"
OLD_PASSWORD=P6dG3U7gq_hY5n6t8Rs9_a
ITBG_MUHAN_OWNER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_USER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_OWNER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_USER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_TOGGLE_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
step 3:
$ORACLE_HOME/bin/sqlplus MUHAN_STRESS_OWNER/${ITBG_MUHAN_STRESS_OWNER_PASSWORD}@${DB_URL}
$ORACLE_HOME/bin/sqlplus MUHAN_OWNER/${ITBG_MUHAN_OWNER_PASSWORD}@${DB_URL}
step 4:
Insert into ps_bundle_site_profile values (1007,'ITBG',1016,1,systimestamp,systimestamp);
select * from ps_bundle_site_profile ;
step 5: Check ACL from Muhan DC to ITBG IP
nc -v 17.113.154.17 8080
step 6:Access the below URL and download the VOLUME-TEST-SNS file and importbun.sh to local computer
https://apple.ent.box.com/folder/113569413517
and rename teh file to VOLUME-TEST-SNS
step 7 :transfer file From local computer to bastion server /tmp/ path
cd /Users/m717018/Downloads
scp VOLUME-TEST-SNS vemad@apck-j1e1-bastion1:/tmp/
scp importbun.sh vemad@gtbn-j1e1-bastion1:/tmp/
step 8 :
scp VOLUME-TEST-SNS vemad@apck-j1p1-muhan3:/tmp/
scp importbun.sh vemad@apck-j1p1-muhan3:/tmp/


step 9:change the permission of the file
chmod 777 VOLUME-TEST-SNS
chmod 777 importbun.sh
step 10:Go to /tmp/ path and copy file to  /ngs/app/home/muhanp/
cp VOLUME-TEST-SNS ~
cp importbun.sh ~
step 11: Do application health check with command whether it shows ok or not.
execute either !curl or curl http://localhost:8080/SNDB/ping
step 12: connect to db using script in the path /ngs/app/home/muhanp/tools/scripts or just copy paste below 2 commands
function get_site_name () { SITE=$(hostname | cut -d. -f1 ); case "$SITE" in *eqwwhk* ) SITE=$(echo $SITE | cut -d- -f3) ;; *atteek* ) SITE=$(echo $SITE | cut -d- -f3) ;; * ) SITE=$(echo $SITE | cut -d- -f1) ;; esac; echo $SITE; }
SITENAME=$(get_site_name)
export ORACLE_HOME=`cat /etc/oratab | grep ^mu${SITENAME} | cut -d: -f2`
DB_SERVICE=MU`echo ${SITENAME} | tr '[:lower:]' '[:upper:]'`_RW
DB_URL="'(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST="localhost")(PORT=1740))(CONNECT_DATA=(SERVICE_NAME="$DB_SERVICE")))'"
OLD_PASSWORD=P6dG3U7gq_hY5n6t8Rs9_a
ITBG_MUHAN_OWNER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_USER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_OWNER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_USER_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
ITBG_MUHAN_STRESS_TOGGLE_PASSWORD=mJba8_CzoNJTVMqBj_9kekgo
step 13:
$ORACLE_HOME/bin/sqlplus MUHAN_STRESS_USER/${ITBG_MUHAN_STRESS_USER_PASSWORD}@${DB_URL}
step 14:Check no of serial numbers exsist is zero
select count(*) from ps_bundle;
step15:Login to any production server where the  VOLUME-TEST-SNS.dms,importbun.sh
step16: run the below command and check whether importbun process is running.
ps -ef |grep importbun
step 17: kill the importbun process
kill pid
step 18:execute importbun.sh using below command
nohup ./importbun.sh VOLUME-TEST-SNS  &
step 19:Check the logs in nohup file using tail command whether any 400 error
step 20:check whether P53 is whitelisted in staging hosts: Production schema, production hosts: Stress schema. Whitelist P38 for both of them.
SQL> select site_code||','||product_code||','||config_code from sn_product_config where product_code='P38';
select * from  ps_bundle_site_profile;
